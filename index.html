<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Mercy Clinics OAC Suite</title>
<link href="manifest.webmanifest" rel="manifest"/>
<meta content="#0a7" name="theme-color"/>
<style>
    :root{--bg:#f6f9fc;--card:#fff;--ink:#0b1220;--muted:#6a758f;--brand:#0a7;--ok:#0b915b;--warn:#c27c00;--danger:#b93535;--border:#d8e1ee;}
    *{box-sizing:border-box} html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,'Segoe UI',Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1120px;margin:0 auto;padding:20px} header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:6px 0 16px}
    .brand{display:flex;gap:12px;align-items:center} .logo{width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,var(--brand),#39c9a6);display:grid;place-items:center;box-shadow:0 6px 16px rgba(10,167,130,.25)}
    .logo img{width:30px;height:30px} h1{font-size:1.35rem;margin:0} .sub{color:var(--muted);font-size:.92rem}
    .tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px} .tab{background:#e9f7f2;color:#075;padding:8px 12px;border-radius:999px;border:1px solid #b7ebdb;cursor:pointer;font-weight:600}
    .tab[aria-selected="true"]{background:var(--brand);color:#fff;border-color:var(--brand)}
    .card{background:var(--card);border-radius:16px;border:1px solid var(--border);box-shadow:0 10px 24px rgba(10,20,60,.06);padding:16px;margin-bottom:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px} .rows{display:grid;gap:10px} label{display:block;font-weight:700;margin-bottom:6px}
    input[type=number],select,input[type=range],input[type=text]{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:1rem} input[type=range]{padding:0}
    .muted{color:var(--muted);font-size:.92rem} .out{font:700 1.15rem/1.2 system-ui} .pill{display:inline-block;background:#e9fbf2;border:1px solid #b3f0d7;color:#07624e;padding:3px 10px;border-radius:999px;font-size:.85rem;margin-left:6px}
    .btn{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer} .btn.ghost{background:transparent;color:var(--brand);border:2px solid var(--brand)}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:12px;margin-top:8px} th,td{padding:9px 10px;text-align:left;border-bottom:1px solid #eef2f8;font-size:.95rem}
    th{background:#f6faf8;font-weight:800} tr:last-child td{border-bottom:none} .badge{font-size:.8rem;padding:2px 8px;border-radius:999px;border:1px solid #ccd}
    .ok{background:#e8f7ee;border-color:#bfe8d0;color:#0b5} .borderline{background:#fff4da;border-color:#ffd89e;color:#a86a00} .low{background:#fdeaea;border-color:#f2b6b6;color:#b21}
    .note{background:#f0f5ff;border:1px dashed #c9d6ff;border-radius:12px;padding:10px 12px} .install{display:none} .hide{display:none} footer{margin-top:18px;color:var(--muted);font-size:.85rem}
    /* print */
    @media print{ body{background:#fff} .tabs, header button, .no-print{display:none !important} .print-block{display:block} .card{box-shadow:none;border:1px solid #ddd} }
    .print-block{display:none}
  
    .tagline{font-style:italic;color:#b23;font-weight:700}
</style>
</head>
<body>
<div class="wrap">
<header>
<div class="brand">
<div class="logo"><img alt="logo" src="assets/logo-mark.png"/></div>
<div>
<h1>OAC Suite — Oral Aperture Tools</h1>
<div class="sub">Mercy Clinics — Dr. Richard E. Nnabuko</div>
</div>
</div>
<button class="btn install" id="installBtn">Install</button>
</header>
<nav class="tabs" role="tablist">
<button aria-selected="true" class="tab" data-panel="calc" role="tab">Calculator</button>
<button aria-selected="false" class="tab" data-panel="reverse" role="tab">Reverse</button>
<button aria-selected="false" class="tab" data-panel="macro" role="tab">Macrostomia Planner</button>
<button aria-selected="false" class="tab" data-panel="thresholds" role="tab">Clinical Thresholds</button>
<button aria-selected="false" class="tab" data-panel="about" role="tab">About/Export</button>
</nav>
<!-- CALCULATOR -->
<section class="panel" id="panel-calc">
<div class="card grid">
<div>
<label for="calcIID">Inter‑incisor distance (IID, mm)</label>
<input id="calcIID" max="80" min="5" step="0.1" type="number" value="35"/>
<label for="calcICD" style="margin-top:10px">Inter‑commissural distance (ICD, mm)</label>
<input id="calcICD" max="120" min="5" step="0.1" type="number" value="45"/>
</div>
<div class="rows">
<div><span class="muted">OAC (Quick) ≈ (π/2)(IID+ICD)</span><div class="out" id="calcOACq">—</div></div>
<div><span class="muted">OAC (Precise, Ramanujan I)</span><div class="out" id="calcOACp">—</div></div>
<div><span class="muted">Δ (Quick − Precise)</span><div class="out" id="calcDelta">—</div></div>
</div>
</div>
<div class="card"><div class="note">Method: use ACTIVE measurements. Quick ≈ is typically within 1–2% of precise ellipse for clinical aspect ratios.</div></div>
</section>
<!-- REVERSE -->
<section class="panel hide" id="panel-reverse">
<div class="card">
<div class="grid">
<div>
<label for="revOAC">Desired OAC (mm)</label>
<input id="revOAC" max="220" min="40" type="number" value="126"/>
</div>
<div>
<label for="revMode">Solve Strategy</label>
<select id="revMode">
<option selected="" value="ratio">Keep aspect ratio (ICD/IID = r)</option>
<option value="fixIID">Lock IID, solve ICD</option>
<option value="fixICD">Lock ICD, solve IID</option>
</select>
<div class="rows" id="revRatioPane" style="margin-top:8px">
<label for="revRatio">Aspect ratio r = ICD/IID <span class="pill" id="revRatioVal">1.20</span></label>
<input id="revRatio" max="1.60" min="0.60" step="0.01" type="range" value="1.20"/>
</div>
<div class="rows" id="revFixIID" style="display:none;margin-top:8px">
<label for="revFixIIDval">Set IID (mm)</label>
<input id="revFixIIDval" max="70" min="10" type="number" value="35"/>
</div>
<div class="rows" id="revFixICD" style="display:none;margin-top:8px">
<label for="revFixICDval">Set ICD (mm)</label>
<input id="revFixICDval" max="90" min="15" type="number" value="45"/>
</div>
</div>
</div>
</div>
<div class="card grid">
<div class="rows">
<div><span class="muted">IID</span><div class="out" id="revOutIID">—</div></div>
<div><span class="muted">ICD</span><div class="out" id="revOutICD">—</div></div>
<div><span class="muted">Check OAC</span><div class="out" id="revCheck">—</div></div>
</div>
<div>
<h3>IID Band (select cohort)</h3>
<select id="cohortA">
<option value="38,5">Children 6–7 y (mean 38, SD 5)</option>
<option value="40.7,4.8">Children 8–9 y</option>
<option value="43.5,5.3">Children 10–11 y</option>
<option value="45.5,5.6">Children 12–13 y</option>
<option value="47.8,5.1">Children 14–15 y</option>
<option value="53.06,6.27">Adult – Nigeria (Yoruba)</option>
<option value="52.77,8.06">Adult – Nigeria (Hausa)</option>
<option value="47.59,8.61">Adult – Nigeria (Igbo)</option>
<option selected="" value="49.33,7.91">Adult – Nigeria (Overall 3 groups)</option>
<option value="46.69,7.29">Adult – Nigeria (2 regions combined)</option>
</select>
<table>
<thead><tr><th>Band</th><th>Threshold</th><th>Status</th></tr></thead>
<tbody id="revBand"></tbody>
</table>
</div>
</div>
</section>
<!-- MACROSTOMIA PLANNER (with staging + print) -->
<section class="panel hide" id="panel-macro">
<div class="card">
<div class="grid">
<div class="rows">
<label for="caseRef">Case reference / patient initials</label>
<input id="caseRef" placeholder="e.g., Mercy-24-083 / R.E." type="text"/>
<label for="curIID">Current IID (mm)</label>
<input id="curIID" max="80" min="10" type="number" value="50"/>
<label for="curICD">Current ICD (mm)</label>
<input id="curICD" max="110" min="10" type="number" value="60"/>
</div>
<div class="rows">
<label for="macGoal">Goal type</label>
<select id="macGoal">
<option selected="" value="targetOAC">Hit a target OAC</option>
<option value="aestheticICD">Set ICD from facial landmarks</option>
</select>
<div class="rows" id="macOACP">
<label for="macOAC">Target OAC (mm)</label>
<input id="macOAC" max="220" min="80" type="number" value="155"/>
<label for="macLock">Lock parameter</label>
<select id="macLock">
<option selected="" value="lockIID">Keep IID (solve ICD)</option>
<option value="lockICD">Keep ICD (solve IID)</option>
<option value="ratio">Keep aspect ratio r</option>
</select>
<div class="rows" id="macKeepIID">
<label for="macIID">IID (keep, mm)</label>
<input id="macIID" max="80" min="15" type="number" value="50"/>
</div>
<div class="rows" id="macKeepICD" style="display:none">
<label for="macICD">ICD (keep, mm)</label>
<input id="macICD" max="110" min="15" type="number" value="60"/>
</div>
<div class="rows" id="macRatioPane" style="display:none">
<label for="macR">Aspect ratio r = ICD/IID <span class="pill" id="macRval">1.20</span></label>
<input id="macR" max="1.60" min="0.60" step="0.01" type="range" value="1.20"/>
</div>
</div>
<div class="rows" id="macAesthP" style="display:none">
<label for="macIPD">Interpupillary distance (IPD, mm)</label>
<input id="macIPD" max="80" min="40" type="number" value="60"/>
<label for="macICDalpha">ICD guideline factor (α)</label>
<input id="macICDalpha" max="1.2" min="0.8" step="0.05" type="number" value="1.00"/>
<div class="muted">Rule-of-thumb: ICD ≈ α × IPD (α ≈ 1.0; adjust by ethnicity/facial analysis).</div>
</div>
</div>
</div>
</div>
<div class="card grid">
<div class="rows">
<h3>Plan Output</h3>
<div><span class="muted">IID (final)</span><div class="out" id="macOutIID">—</div></div>
<div><span class="muted">ICD (final)</span><div class="out" id="macOutICD">—</div></div>
<div><span class="muted">OAC (check)</span><div class="out" id="macOutOAC">—</div></div>
<div><span class="muted">Composite label</span><div class="out" id="macLabel">—</div></div>
</div>
<div class="rows">
<h3>Safety Rails</h3>
<table>
<thead><tr><th>Check</th><th>Threshold</th><th>Status</th></tr></thead>
<tbody id="macSafety"></tbody>
</table>
<div class="muted">Use clinical judgement. Consider orbicularis competence, speech, drooling risk, esthetics.</div>
</div>
</div>
<div class="card">
<div class="grid">
<div class="rows">
<h3>Staging Helper</h3>
<label for="stages">Stages</label>
<select id="stages">
<option selected="" value="1">Single-stage</option>
<option value="2">Two-stage</option>
</select>
<div class="rows" id="stageSplitPane" style="display:none">
<label for="stageSplit">Stage 1 proportion (%)</label>
<input id="stageSplit" max="90" min="10" type="number" value="60"/>
<div class="muted">Stage 1 applies this % of the total change; Stage 2 completes the remainder.</div>
</div>
</div>
<div class="rows">
<table>
<thead><tr><th>Stage</th><th>IID</th><th>ICD</th><th>OAC</th><th>IID band</th><th>ICD severity</th></tr></thead>
<tbody id="stageRows"></tbody>
</table>
<div class="no-print"><button class="btn ghost" id="printBtn">Print / Save PDF</button></div>
</div>
</div>
</div>
<!-- Print summary -->
<div class="print-block card" id="printArea"><div style="display:flex;align-items:center;gap:12px;margin-bottom:6px"><img src="assets/logo-horizontal.png" style="height:40px"/><div class="tagline">In His Hands</div></div>
<h2>Macrostomia Plan — Mercy Clinics — Dr. Richard E. Nnabuko</h2>
<div class="muted" id="printMeta"></div>
<h3>Targets</h3>
<div id="printTargets"></div>
<h3>Staging</h3>
<div id="printStages"></div>
<h3>Safety</h3>
<div id="printSafety"></div>
<p class="muted">Generated by OAC Suite PWA. Method: Quick ellipse OAC; cohort-aware bands.</p>
</div>
</section>
<!-- THRESHOLDS -->
<section class="panel hide" id="panel-thresholds">
<div class="card">
<h3>Clinical bands (IID)</h3>
<div class="grid">
<div class="rows">
<label for="thrCohort">Cohort</label>
<select id="thrCohort">
<option value="38,5">Children 6–7 y</option>
<option value="40.7,4.8">Children 8–9 y</option>
<option value="43.5,5.3">Children 10–11 y</option>
<option value="45.5,5.6">Children 12–13 y</option>
<option value="47.8,5.1">Children 14–15 y</option>
<option value="53.06,6.27">Adult – Nigeria (Yoruba)</option>
<option value="52.77,8.06">Adult – Nigeria (Hausa)</option>
<option value="47.59,8.61">Adult – Nigeria (Igbo)</option>
<option selected="" value="49.33,7.91">Adult – Nigeria (Overall 3 groups)</option>
<option value="46.69,7.29">Adult – Nigeria (2 regions combined)</option>
</select>
</div>
<div class="rows">
<div><span class="muted">Mean IID</span><div class="out" id="thrMean">—</div></div>
<div><span class="muted">Likely low (≈ mean − 2SD)</span><div class="out" id="thrLow">—</div></div>
</div>
</div>
</div>
<div class="card">
<h3>Miller &amp; O’Neill – Severity by ICD</h3>
<table>
<thead><tr><th>Band</th><th>ICD threshold</th></tr></thead>
<tbody>
<tr><td>Mild</td><td>&gt; 30 mm</td></tr>
<tr><td>Moderate</td><td>15–30 mm</td></tr>
<tr><td>Severe</td><td>&lt; 15 mm</td></tr>
</tbody>
</table>
</div>
</section>
<!-- ABOUT / EXPORT -->
<section class="panel hide" id="panel-about">
<div class="card">
<div style="display:flex;gap:12px;align-items:center">
<img alt="Mercy Clinics" src="assets/logo-horizontal.png" style="height:42px"/>
<div>
<h3 style="margin:0">About</h3>
<div class="muted">This offline PWA unifies OAC Calculator, Reverse solver, and a Macrostomia Planner with staging and print-to-PDF export.</div>
</div>
</div>
<ul>
<li><b>Quick OAC</b>: π/2 × (IID + ICD)</li>
<li><b>Precise OAC</b> (Ramanujan I): π[3(a+b) − √((3a+b)(a+3b))], with a=IID/2, b=ICD/2</li>
<li><b>Safety rails</b>: cohort “likely low” = mean − 2SD; ICD severity bands</li>
</ul>
<div class="note">Tip: Use the “Print / Save PDF” button in the Macrostomia Planner to produce a one‑page plan. Printer dialog → “Save as PDF”.</div>
</div>
</section>
<footer>© Mercy Clinics — Dr. Richard E. Nnabuko. Works offline after first load. Install from your browser menu.<span class="tagline"> In His Hands</span></footer>
</div>
<script>
if ('serviceWorker' in navigator) {{ window.addEventListener('load', () => navigator.serviceWorker.register('sw.js')); }}
let deferredPrompt; const installBtn = document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt', (e)=>{{ e.preventDefault(); deferredPrompt=e; installBtn.style.display='inline-block'; }});
installBtn?.addEventListener('click', async()=>{{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.style.display='none'; }});

const panels = ['calc','reverse','macro','thresholds','about'];
document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',()=>{{
  const p = btn.dataset.panel;
  document.querySelectorAll('.tab').forEach(b=>b.setAttribute('aria-selected', String(b===btn)));
  panels.forEach(id => document.getElementById('panel-'+id).classList.toggle('hide', id!==p));
}}));

const $ = id => document.getElementById(id);
function qOAC(iid,icd) {{ return Math.PI/2*(iid+icd); }}
function pOAC(iid,icd) {{ const a=iid/2, b=icd/2; return Math.PI*(3*(a+b)-Math.sqrt((3*a+b)*(a+3*b))); }}
function bandIID(iid, mean, sd) {{ const low=mean-2*sd; return {{ low, band: iid<low?'LOW':(iid<mean?'BORDERLINE':'WITHIN EXPECTED') }}; }}
function sevICD(icd) {{ return icd<15?'Severe':(icd<=30?'Moderate':'Mild'); }}

function calcUpdate(){{
  const IID=parseFloat($('#calcIID').value||'0'), ICD=parseFloat($('#calcICD').value||'0');
  const oq=qOAC(IID,ICD), op=pOAC(IID,ICD);
  $('#calcOACq').textContent=oq.toFixed(1)+' mm';
  $('#calcOACp').textContent=op.toFixed(1)+' mm';
  $('#calcDelta').textContent=(oq-op).toFixed(1)+' mm';
}}
['calcIID','calcICD'].forEach(id=>$(id).addEventListener('input',calcUpdate)); calcUpdate();

function revCompute(){{
  const target=parseFloat($('#revOAC').value||'0'); const sum=2/Math.PI*target; let IID, ICD;
  const mode = $('#revMode').value;
  if(mode==='ratio'){{ const r=parseFloat($('#revRatio').value||'1.2'); IID=sum/(1+r); ICD=r*IID; }}
  else if(mode==='fixIID'){{ IID=parseFloat($('#revFixIIDval').value||'35'); ICD=sum-IID; }}
  else {{ ICD=parseFloat($('#revFixICDval').value||'45'); IID=sum-ICD; }}
  $('#revOutIID').textContent=IID.toFixed(1)+' mm';
  $('#revOutICD').textContent=ICD.toFixed(1)+' mm';
  $('#revCheck').textContent=qOAC(IID,ICD).toFixed(1)+' mm';
  const [m,sd]=$('#cohortA').value.split(',').map(parseFloat);
  const {{low, band}}=bandIID(IID,m,sd);
  $('#revBand').innerHTML = `
    <tr><td>Likely Low</td><td>${{low.toFixed(1)}} mm</td><td><span class="badge ${{band==='LOW'?'low':(band==='BORDERLINE'?'borderline':'ok')}}">${{band}}</span></td></tr>
    <tr><td>Mean</td><td>${{m.toFixed(1)}} mm</td><td>—</td></tr>`;
}}
function revModeUI(){{
  const mode=$('#revMode').value;
  $('#revRatioPane').style.display = mode==='ratio'?'block':'none';
  $('#revFixIID').style.display = mode==='fixIID'?'block':'none';
  $('#revFixICD').style.display = mode==='fixICD'?'block':'none';
  revCompute();
}}
['revOAC','revMode','revRatio','revFixIIDval','revFixICDval','cohortA'].forEach(id=>$(id).addEventListener('input',revCompute));
$('#revMode').addEventListener('change',revModeUI); $('#revRatio').addEventListener('input',()=>$('#revRatioVal').textContent=parseFloat($('#revRatio').value).toFixed(2)); revModeUI();

function macUI(){{
  const goal=$('#macGoal').value;
  $('#macOACP').style.display = goal==='targetOAC'?'block':'none';
  $('#macAesthP').style.display = goal==='aestheticICD'?'block':'none';
  const lock=$('#macLock').value;
  $('#macKeepIID').style.display = lock==='lockIID'?'block':'none';
  $('#macKeepICD').style.display = lock==='lockICD'?'block':'none';
  $('#macRatioPane').style.display = lock==='ratio'?'block':'none';
  $('#stageSplitPane').style.display = $('#stages').value==='2' ? 'block' : 'none';
  macCompute();
}}
function macCompute(){{
  const curIID=parseFloat($('#curIID').value||'0'), curICD=parseFloat($('#curICD').value||'0');
  let IID, ICD, targetOAC;
  if($('#macGoal').value==='targetOAC'){{
    targetOAC = parseFloat($('#macOAC').value||'0');
    const sum = 2/Math.PI*targetOAC;
    const lock = $('#macLock').value;
    if(lock==='lockIID'){{ IID=parseFloat($('#macIID').value||'50'); ICD=sum-IID; }}
    else if(lock==='lockICD'){{ ICD=parseFloat($('#macICD').value||'60'); IID=sum-ICD; }}
    else {{ const r=parseFloat($('#macR').value||'1.2'); IID=sum/(1+r); ICD=r*IID; }}
  }} else {{
    const IPD=parseFloat($('#macIPD').value||'60'), alpha=parseFloat($('#macICDalpha').value||'1.0');
    ICD = alpha*IPD; const r=parseFloat($('#macR').value||'1.2'); IID = ICD/r; targetOAC = qOAC(IID,ICD);
  }}
  $('#macOutIID').textContent=IID.toFixed(1)+' mm';
  $('#macOutICD').textContent=ICD.toFixed(1)+' mm';
  $('#macOutOAC').textContent=targetOAC.toFixed(1)+' mm';
  const sev = sevICD(ICD);
  const [m,sd]=$('#macCohort').value.split(',').map(parseFloat);
  const {{low, band}} = bandIID(IID,m,sd);
  const chan = $('#macChan').value;
  $('#macLabel').textContent = `${{sev}} (ICD ${{ICD.toFixed(1)}} mm), Type ${{chan}} • IID band: ${{band}}`;
  $('#macSafety').innerHTML = `
    <tr><td>ICD severity</td><td>Mild &gt;30 | Moderate 15–30 | Severe &lt;15</td>
        <td><span class="badge ${{sev==='Severe'?'low':(sev==='Moderate'?'borderline':'ok')}}">${{sev}}</span></td></tr>
    <tr><td>IID cohort low</td><td>&lt; ${{(m-2*sd).toFixed(1)}} mm</td>
        <td><span class="badge ${{band==='LOW'?'low':(band==='BORDERLINE'?'borderline':'ok')}}">${{band}}</span></td></tr>`;

  const stages = parseInt($('#stages').value||'1',10);
  const split = Math.min(90, Math.max(10, parseFloat($('#stageSplit').value||'60'))) / 100.0;
  const dIID = IID - curIID; const dICD = ICD - curICD;
  const IID1 = stages===1 ? IID : curIID + dIID*split;
  const ICD1 = stages===1 ? ICD : curICD + dICD*split;
  const OAC1 = qOAC(IID1,ICD1); const sev1 = sevICD(ICD1); const {{band:band1}} = bandIID(IID1,m,sd);
  const IID2 = IID; const ICD2 = ICD; const OAC2 = qOAC(IID2,ICD2); const sev2 = sevICD(ICD2); const {{band:band2}} = bandIID(IID2,m,sd);
  const rows = stages===1
    ? `<tr><td>Final</td><td>${{IID2.toFixed(1)}}</td><td>${{ICD2.toFixed(1)}}</td><td>${{OAC2.toFixed(1)}}</td>
        <td><span class="badge ${{band2==='LOW'?'low':(band2==='BORDERLINE'?'borderline':'ok')}}">${{band2}}</span></td>
        <td><span class="badge ${{sev2==='Severe'?'low':(sev2==='Moderate'?'borderline':'ok')}}">${{sev2}}</span></td></tr>`
    : `<tr><td>Stage 1</td><td>${{IID1.toFixed(1)}}</td><td>${{ICD1.toFixed(1)}}</td><td>${{OAC1.toFixed(1)}}</td>
         <td><span class="badge ${{band1==='LOW'?'low':(band1==='BORDERLINE'?'borderline':'ok')}}">${{band1}}</span></td>
         <td><span class="badge ${{sev1==='Severe'?'low':(sev1==='Moderate'?'borderline':'ok')}}">${{sev1}}</span></td></tr>
       <tr><td>Stage 2</td><td>${{IID2.toFixed(1)}}</td><td>${{ICD2.toFixed(1)}}</td><td>${{OAC2.toFixed(1)}}</td>
         <td><span class="badge ${{band2==='LOW'?'low':(band2==='BORDERLINE'?'borderline':'ok')}}">${{band2}}</span></td>
         <td><span class="badge ${{sev2==='Severe'?'low':(sev2==='Moderate'?'borderline':'ok')}}">${{sev2}}</span></td></tr>`;
  document.getElementById('stageRows').innerHTML = rows;

  document.getElementById('printMeta').textContent = `Case: ${{document.getElementById('caseRef').value||'-'}} | Cohort: ${{m.toFixed(1)}}±${{sd.toFixed(1)}} mm | Chan Type: ${{chan}}`;
  document.getElementById('printTargets').innerHTML = `IID: <b>${{IID.toFixed(1)}} mm</b> • ICD: <b>${{ICD.toFixed(1)}} mm</b> • OAC: <b>${{targetOAC.toFixed(1)}} mm</b> • ICD severity: <b>${{sev}}</b> • IID band: <b>${{band}}</b>`;
  document.getElementById('printStages').innerHTML = stages===1
    ? `Single-stage ⇢ IID ${{IID2.toFixed(1)}} mm, ICD ${{ICD2.toFixed(1)}} mm (OAC ${{OAC2.toFixed(1)}} mm)`
    : `Stage 1 (${{(split*100).toFixed(0)}}%): IID ${{IID1.toFixed(1)}}, ICD ${{ICD1.toFixed(1)}} (OAC ${{OAC1.toFixed(1)}}) <br> Stage 2: IID ${{IID2.toFixed(1)}}, ICD ${{ICD2.toFixed(1)}} (OAC ${{OAC2.toFixed(1)}})`;
  document.getElementById('printSafety').innerHTML = document.getElementById('macSafety').innerHTML;
}}
['macGoal','macOAC','macLock','macIID','macICD','macR','macIPD','macICDalpha','macCohort','macChan','curIID','curICD','stages','stageSplit','caseRef'].forEach(id=>$(id).addEventListener('input',macCompute));
$('#macLock').addEventListener('change',macUI); $('#macGoal').addEventListener('change',macUI);
$('#macR').addEventListener('input',()=>$('#macRval').textContent=parseFloat($('#macR').value).toFixed(2)); $('#stages').addEventListener('change',macUI);
document.getElementById('printBtn').addEventListener('click',()=>window.print());
macUI();

function thrUpdate(){{
  const [m,sd]=$('#thrCohort').value.split(',').map(parseFloat);
  $('#thrMean').textContent=m.toFixed(1)+' mm';
  $('#thrLow').textContent=(m-2*sd).toFixed(1)+' mm';
}}
$('#thrCohort').addEventListener('input',thrUpdate); thrUpdate();
</script>
</body>
</html>
